<html>
<head>
  <link href = "https://micro.blog/jsonbecker" rel = "me" />
  <link href = "/css/post.css" rel = "stylesheet" type = "text/css">
  
  <link rel="stylesheet" href="/css/tomorrow-night-bright.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css">
  <script src="/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
<body class='site'>
    <header class = "title-bar">
      <span class = "site-title"> json.blog </span>
      <nav class = "nav">
          <a href = "http://www.json.blog">Home</a> |
          <a href = "/archive">Archives</a> |
          <a href = "http://jsonbecker.com">About</a>
      </nav>
    </header>
  <main> 


 <article class = "h-entry">
  <div class = "post-title">
      <h1 class = "p-name">Labeling Data with purrr</h1>
    <time class = "date dt-published">March 03, 2017</time> 
    <div class = "perma"><a class = "u-url" href = "http://www.json.blog/2017/03/labeling-data-with-purrr/">&infin;</a></div>
  </div>

 <div class = "post-content e-content">
   <p>Here&rsquo;s a fun common task. I have a data set that has a bunch of codes like:</p>

<table>
<thead>
<tr>
<th align="left">Name</th>
<th align="center">Abbr</th>
<th align="right">Code</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Alabama</td>
<td align="center">AL</td>
<td align="right">01</td>
</tr>

<tr>
<td align="left">Alaska</td>
<td align="center">AK</td>
<td align="right">02</td>
</tr>

<tr>
<td align="left">Arizona</td>
<td align="center">AZ</td>
<td align="right">04</td>
</tr>

<tr>
<td align="left">Arkansas</td>
<td align="center">AR</td>
<td align="right">05</td>
</tr>

<tr>
<td align="left">California</td>
<td align="center">CA</td>
<td align="right">06</td>
</tr>

<tr>
<td align="left">Colorado</td>
<td align="center">CO</td>
<td align="right">08</td>
</tr>

<tr>
<td align="left">Connecticut</td>
<td align="center">CT</td>
<td align="right">09</td>
</tr>

<tr>
<td align="left">Delaware</td>
<td align="center">DE</td>
<td align="right">10</td>
</tr>
</tbody>
</table>

<p>All of your data is labeled with the <code>code</code> value. In this case, you want to do a <code>join</code> so that you can use the actual names because it&rsquo;s 2017 and we&rsquo;re not animals.</p>

<p>But what if your data, like the accounting data we deal with at <a href="http://www.allovue.com">Allovue</a>, has lots of code fields. You probably either have one table that contains all of the look ups in &ldquo;long&rdquo; format, where there is a column that represents which column in your data the code is for like this:</p>

<table>
<thead>
<tr>
<th align="left">code</th>
<th align="center">type</th>
<th align="right">name</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">01</td>
<td align="center">fips</td>
<td align="right">Alabama</td>
</tr>

<tr>
<td align="left">02</td>
<td align="center">fips</td>
<td align="right">Alaska</td>
</tr>
</tbody>
</table>

<p>Alternatively, you may have a lookup table per data element (so one called fips, one called account, one called function, etc).</p>

<p>I bet most folks do the following in this scenario:</p>

<pre><code class="language-r">account &lt;- left_join(account, account_lookup)
account &lt;- left_join(account, fips)

## Maybe this instead ##
account %&lt;&gt;%
  left_join(account_lookup) %&gt;%
  left_join(fips)
</code></pre>

<p>I want to encourage you to do this a little different using <code>purrr</code>. Here&rsquo;s some annotated code that uses <code>reduce_right</code> to make magic.</p>

<pre><code class="language-r"># Load a directory of .csv files that has each of the lookup tables
lookups &lt;- map(dir('data/lookups'), read.csv, stringsAsFactors = FALSE)
# Alternatively if you have a single lookup table with code_type as your
# data attribute you're looking up
# lookups &lt;- split(lookups, code_type)
lookups$real_data &lt;- read.csv('data/real_data.csv', 
                              stringsAsFactors = FALSE)
real_data &lt;- reduce_right(lookups, left_join)
</code></pre>

<p>Boom, now you went from data with attributes like <code>funds_code</code>, <code>function_code</code>, <code>state_code</code> to data that also has <code>funds_name</code>, <code>function_name</code>, <code>state_name</code><sup class="footnote-ref" id="fnref:namingconventions"><a href="#fn:namingconventions">1</a></sup>. What&rsquo;s great is that this same code can be reused no matter how many fields require a hookup. I&rsquo;m oftent dealing with accounting data where the accounts are defined by a different number of data fields, but my code doesn&rsquo;t care at all.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:namingconventions">My recommendation is to use consistent naming conventions like <code>_code</code> and <code>_name</code> so that knowing how to do the lookups is really straightforward. This is not unlike the convention with Microsoft SQL where the primary key of a table is named <code>Id</code> and a foreign key to that table is named <code>TableNameId</code>. Anything that helps you figure out how to put things together without thinking is worth it.
 <a class="footnote-return" href="#fnref:namingconventions"><sup>[return]</sup></a></li>
</ol>
</div>

 </div>
 <span class = "h-card">
    <a class ="p-author u-url"a href="http://jsonbecker.com"> Jason P. Becker</a>
  </span>
</article>


  </main>
  <footer class = "license center">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: #fff;">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-40920108-1", 'auto');
  ga('send', 'pageview');
</script>
</footer>
    </body>
</html>
