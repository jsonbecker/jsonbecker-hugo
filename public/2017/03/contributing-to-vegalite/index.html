<html>
<head>
  <link href = "https://micro.blog/jsonbecker" rel = "me" />
  <link href = "/css/post.css" rel = "stylesheet" type = "text/css">
  
  <link rel="stylesheet" href="/css/tomorrow-night-bright.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css">
  <script src="/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
<body>
  <div class = "site">
    <header class = "title-bar">
      <nav>
        <span class = "site-title"> <a href = "http://www.json.blog">json.blog </a></span>
        <span class = "nav">
          <a href = "https://jsonbecker.com">About</a>
          <a href = "https://micro.json.blog" rel="me">Micro</a>
          <a href = "https://www.github.com/jsonbecker">Github</a>
        </span>
      </nav>
    </header>
  <main> 


 <article class = "h-entry">
  <div class = "post-title">
    <time class = "date dt-published">March 02, 2017</time> 
    <h1 class = "p-name"><a class = "u-url" href = "http://www.json.blog/2017/03/contributing-to-vegalite/">Contributing to vegalite</a></h1>
  </div>

 <div class = "post-content e-content">
   <p>One of my goals for 2017 is to contribute more to the R open source community. At the beginning of last year, I spent a little time helping to refactor <a href="https://www.github.com/leeper/rio">rio</a>. It was one of the more rewarding things I did in all of 2016. It wasn&rsquo;t a ton of work, and I feel like I gained a lot of confidence in writing R packages and using S3 methods. I wrote code that R users download and use thousands of times a month.</p>

<p>I have been on the lookout for a Javascript powered interactive charting library since <code>ggvis</code> was announced in 2014. But <code>ggvis</code> seems to have stalled out in favor of other projects (for now) and the evolution of <code>rCharts</code> into <code>htmlwidgets</code> left me feeling like there were far too many options and no clear choices.</p>

<p>What I was looking for was a plotting library to make clean, attractive graphics with tool tips that came with clear documentation and virtually no knowledge of Javascript required. Frankly, all of the <code>htmlwidgets</code> stuff was very intimidating. From my vantage point skimming blog posts and watching stuff come by on Twitter, <code>htmlwidgets</code>-based projects all felt very much directed at Javascript polyglots.</p>

<p>Vega and Vega-Lite had a lot of the qualities I sought in a plotting library. Reading and writing JSON is very accessible compared to learning Javascript, especially with R&rsquo;s excellent translation from lists to JSON. And although I know almost no Javascript, I found in both Vega and Vega-Lite easy to understand documents that felt a lot like building grammar of graphics <sup class="footnote-ref" id="fnref:thegg"><a href="#fn:thegg">1</a></sup> plots.</p>

<p>So I decided to take the plunge&ndash; there was a <code>vegalite</code> <a href="https://github.com/hrbrmstr/vegalite">package</a> and the examples didn&rsquo;t look so bad. It was time to use my first <code>htmlwidgets</code> package.</p>

<p>Things went great. I had some simple data and I wanted to make a bar chart. I wrote:</p>

<pre><code class="language-r">vegalite() %&gt;%
add_data(my_df) %&gt;%
encode_x('schools', type = 'nominal') %&gt;%
encode_y('per_pupil', type = 'quantitative') %&gt;%
mark_bar()
</code></pre>

<p>A bar chart was made! But then I wanted to use the font Lato, which is what we use at <a href="http://www.allovue.com">Allovue</a>. No worries, Vega-Lite has a property called <code>titleFont</code> for axes. So I went to do:</p>

<pre><code class="language-r">vegalite() %&gt;%
add_data(my_df) %&gt;%
encode_x('schools', type = 'nominal') %&gt;%
encode_y('per_pupil', type = 'quantitative') %&gt;%
mark_bar() %&gt;%
axis_x(titleFont = 'Lato')
</code></pre>

<p>Bummer. It didn&rsquo;t work. I almost stopped there, experiment over. But then I remembered my goal and I thought, maybe I need to learn to contribute to a package that is an <code>htmlwidget</code> and not simply use an <code>htmlwidget</code>-based package. I should at least <em>look</em> at the code.</p>

<p>What I found surprised me. Under the hood, all the R package does is build up lists. It makes so much sense&ndash; pass JSON to Javascript to process and do what&rsquo;s needed.</p>

<p>So it turned out, <code>vegalite</code> for R was a bit behind the current version of <code>vegalite</code> and didn&rsquo;t have the <code>titleFont</code> property yet. And with that, I made my <a href="https://github.com/hrbrmstr/vegalite/commit/8f4d4db057985bac4fc8c5743780b4746dd56c56">first commit</a>. All I had to do was update the function definition and add the new arguments to the axis data like so:</p>

<pre><code class="language-r">if (!is.null(titleFont))    vl$x$encoding[[chnl]]$axis$titleFont &lt;- titleFont
</code></pre>

<p>But why stop there? I wanted to update all of <code>vegalite</code> to use the newest available arguments. Doing so looked like a huge pain though. The original package author made these great functions like <code>axis_x</code> and <code>axis_y</code>. They both had the same arguments, the only difference was the &ldquo;channel&rdquo; was preset as <code>x</code> or <code>y</code> based on which function was called. Problem was that all of the arguments, all of the assignments, and all of the documentation had to be copied twice. It was worse with <code>encode</code> and <code>scale</code> which had many, many functions that are similar or identical in their &ldquo;signature&rdquo;. No wonder the package was missing so many Vega-Lite features&ndash; they were a total pain to add.</p>

<p>So as a final step, I decided I would do a light refactor across the whole package. In each of the core functions, like <code>encode</code> and <code>axis</code>, I would write a single generic function like <code>encode_vl()</code> that would hold all of the possible arguments for the <a href="https://vega.github.io/vega-lite/docs/encoding.html">encoding portion</a> of Vega-Lite. Then the specific functions like <code>encode_x</code> could become wrapper functions that internally call <code>encode_vl</code> like so:</p>

<pre><code class="language-r">encode_x &lt;- function(vl, ...) {
  vl &lt;- encode_vl(vl, chnl = &quot;x&quot;, ...)
  vl
}

encode_y &lt;- function(vl, ...) {
  vl &lt;- encode_vl(vl, chnl =&quot;y&quot;, ...)
  vl
}

encode_color &lt;- function(vl, ...) {
  vl &lt;- encode_vl(vl, chnl = &quot;color&quot;, ...)
  vl
}
</code></pre>

<p>Now, in order to update the documentation and the arguments for <code>encoding</code>, I just have to update the <code>encode_vl</code> function. It&rsquo;s a really nice demonstration, in my opinion, of the power of R&rsquo;s <code>...</code> syntax. All of the wrapper functions can just pass whatever additional arguments the caller wants to <code>encode_vl</code> without having to explicitly list them each time.</p>

<p>This greatly reduced duplication in the code and made it far easier to update <code>vegalite</code> to the newest version of Vega-Lite, which I also decided to do.</p>

<p>Now Vega-Lite itself is embarking on a 2.0 release that I have a feeling will have some pretty big changes in store. I&rsquo;m not sure if I&rsquo;ll be the one to update <code>vegalite</code>&ndash; in the end, I think that Vega-Lite is too simple for the visualizations I need to do&ndash; but I am certain whoever does the update will have a much easier go of it now than they would have just over a month ago.</p>

<p>Thanks to <a href="https://github.com/hrbrmstr">Bob Rudis</a> for making <code>vegalite</code> and giving me free range after a couple of commits to go hog-wild on his package!</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:thegg">The <code>gg</code> in <code>ggplot2</code>.
 <a class="footnote-return" href="#fnref:thegg"><sup>[return]</sup></a></li>
</ol>
</div>

 </div>
 <span class = "h-card">
    <a class ="p-author u-url"a href="http://jsonbecker.com"> Jason P. Becker</a>
  </span>
</article>


  </main>
  <footer> 
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-40920108-1", 'auto');
  ga('send', 'pageview');
</script>
</footer>
    </div>
    </body>
</html>
