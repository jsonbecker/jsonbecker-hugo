<html>
<head>
	<meta name="generator" content="Hugo 0.21-DEV" />
  <link href = "http://www.json.blog/css/simple-grid.css" rel = "stylesheet" type = "text/css"> 
  <link href = "http://www.json.blog/css/post.css" rel = "stylesheet" type = "text/css">
  
    <link href="http://www.json.blog/index.xml" rel="alternate" type="application/rss+xml" title="JSONBecker" />
    <link href="http://www.json.blog/index.xml" rel="feed" type="application/rss+xml" title="JSONBecker" />
  
  <link rel="stylesheet" href="http://www.json.blog/css/tomorrow-night-bright.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css">
  <script src="http://www.json.blog/js/highlight.pack.js"></script>
  <script>  
    hljs.initHighlightingOnLoad();
  </script>
	<script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  	ga('create', 'UA-40920108-1', 'auto');
  	ga('send', 'pageview');
	</script>
<body>
    <div class = "title-bar">
      <h1 class = "title"> json.blog </h1>
      <h3 class = "nav">
          <a href = "http://www.json.blog">Home</a> | 
          <a href = "http://www.json.blog/archive">Archives</a> |
          <a href = "http://jsonbecker.com">About</a>
      </h3>
    </div>
  <div class = 'container'>
  
  




    
        <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Making Sense of dplyr 0.6</h1>
    <h6 class = "date">May 18, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/05/making-sense-of-dplyr-0.6/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      

<p>Non-standard evaluation is one of R&rsquo;s best features, and also one of it&rsquo;s most perplexing. Recently I have been making good use of <code>wrapr::let</code> to allow me to write reusable functions without a lot of assumptions about my data. For example, let&rsquo;s say I always want to <code>group_by</code> schools when adding up dollars spent, but that sometimes my data calls what is conceptually a school <code>schools</code>, <code>school</code>, <code>location</code>, <code>cost_center</code>, <code>Loc.Name</code>, etc. What I have been doing is storing a set of parameters in a <code>list</code> that mapped the actual names in my data to consistent names I want to use in my code. Sometimes that comes from using <code>params</code> in an Rmd file. So the top of my file may say something like:</p>

<pre><code class="language-yaml">params:
    school: &quot;locations&quot;
    amount: &quot;dollars&quot;
    enrollment: n
</code></pre>

<p>In my code, I may want to write a chain like</p>

<pre><code class="language-r">create_per_pupil &lt;- . %&gt;%
                    group_by(school) %&gt;%
                    summarize(per_pupil = sum(amount) / n)
pp &lt;- district_data %&gt;%
      create_per_pupil
</code></pre>

<p>Only my problem is that <code>school</code> isn&rsquo;t always <code>school</code>. In this toy case, you could use <code>group_by_(params$school)</code>, but it&rsquo;s pretty easy to run into limitations with the <code>_</code> functions in <code>dplyr</code> when writing functions.</p>

<p>Using <code>wrapr::let</code>, I can easily use the code above:</p>

<pre><code class="language-r">let(alias = params, {
    create_per_pupil &lt;- . %&gt;%
                        group_by(school) %&gt;%
                        summarize(per_pupil = sum(amount)/n)
})

pp &lt;- district_data %&gt;%
      create_per_pupil
</code></pre>

<p>The core of <code>wrapr::let</code> is really scary.</p>

<pre><code class="language-r">body &lt;- strexpr
for (ni in names(alias)) {
    value &lt;- as.character(alias[[ni]])
    if (ni != value) {
        pattern &lt;- paste0(&quot;\\b&quot;, ni, &quot;\\b&quot;)
        body &lt;- gsub(pattern, value, body)
    }
}
parse(text = body)
</code></pre>

<p>Basically let is holidng onto the code block contained within it, iterating over the list of key-value pairs that are provided, and then runs a <code>gsub</code> on word boundaries to replace all instances of the list names with their values. Yikes.</p>

<p>This works, I use it all over, but I have never felt confident about it.</p>

<h2 id="the-new-world-of-tidyeval">The New World of tidyeval</h2>

<p>The release of dplyr 0.6 along with tidyeval brings wtih it a ton of features to making programming over dplyr functions far better supported. I am going to <a href="http://dplyr.tidyverse.org/articles/programming.html">read this page</a> by Hadley Wickham at least 100 times. There are all kinds of new goodies (<code>!!!</code> looks amazing).</p>

<p>So how would I re-write the chain above sans <code>let</code>?</p>

<pre><code class="language-r">create_per_pupil &lt;- . %&gt;%
                    group_by(!!sym(school)) %&gt;%
                    summarize(per_pupil = sum(amount)/n)
</code></pre>

<p>If I understand <code>tidyeval</code>, then this is what&rsquo;s going on.</p>

<ul>
<li><code>sym</code> evaluates <code>school</code> and makes the result a <code>symbol</code></li>
<li>and <code>!!</code> says, roughly &ldquo;evaluate that symbol now&rdquo;.</li>
</ul>

<p>This way with <code>params$school</code> having the value <code>&quot;school_name&quot;</code>, <code>sym(school)</code> creates evaulates that to <code>&quot;school_name&quot;</code> and then makes it an unquoted symbol <code>school_name</code>. Then <code>!!</code> tells R &ldquo;You can evaluate this next thing in place as it is.&rdquo;</p>

<p>I originally wrote this post trying to understand <code>enquo</code>, but I never got it to work right and it makes no sense to me yet. What&rsquo;s great is that <code>rlang::sym</code> and <code>rlang::syms</code> with <code>!!</code> and <code>!!!</code> respectively work really well so far. There is definitely less flexibility&ndash; with the full on <code>quosure</code> stuff you can have very complex evaluations. But I&rsquo;m mostly worried about having very generic names for my data so <code>sym</code> and <code>syms</code> seems to work great.</p>

    </div>
  </div>

      <hr>
    
  

  
      <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Foreign Keys and assertr</h1>
    <h6 class = "date">April 02, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/04/foreign-keys-and-assertr/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      I have been fascinated with assertive programming in R since this from 2015 1. Tony Fischetti wrote a great blog post to announce assertr 2.0&rsquo;s release on CRAN that really clarified the package&rsquo;s design.
UseRs often do crazy things that no sane developer in another language would do. Today I decided to build a way to check foreign key constraints in R to help me learn the assertr package.
      
        <h6 class="perma"><a href="/2017/04/foreign-keys-and-assertr/">Read More&hellip;</a></h6>
      
    </div>
    <hr>
  </div>


  
  
      <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Labeling Data with purrr</h1>
    <h6 class = "date">March 03, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/03/labeling-data-with-purrr/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      Here&rsquo;s a fun common task. I have a data set that has a bunch of codes like:
   Name Abbr Code     Alabama AL 01   Alaska AK 02   Arizona AZ 04   Arkansas AR 05   California CA 06   Colorado CO 08   Connecticut CT 09   Delaware DE 10    All of your data is labeled with the code value.
      
        <h6 class="perma"><a href="/2017/03/labeling-data-with-purrr/">Read More&hellip;</a></h6>
      
    </div>
    <hr>
  </div>


  
  
      <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Contributing to vegalite</h1>
    <h6 class = "date">March 02, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/03/contributing-to-vegalite/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      One of my goals for 2017 is to contribute more to the R open source community. At the beginning of last year, I spent a little time helping to refactor rio. It was one of the more rewarding things I did in all of 2016. It wasn&rsquo;t a ton of work, and I feel like I gained a lot of confidence in writing R packages and using S3 methods. I wrote code that R users download and use thousands of times a month.
      
        <h6 class="perma"><a href="/2017/03/contributing-to-vegalite/">Read More&hellip;</a></h6>
      
    </div>
    <hr>
  </div>


  
  
      <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>My confrontation with the mainstream</h1>
    <h6 class = "date">February 27, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/02/my-confrontation-with-the-mainstream/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      You can check my Goodreads profile. I love science fiction and fantasy. And I know in 2017 and everyone has already observed the dominance of &ldquo;geek culture&rdquo;, with the dominance of Disney properties from Marvel and now Star Wars. Hell, Suicide Squad won a goddamn Oscar.
  Powell's Best Selling Fiction, 2017-02-26    Powell's Best Selling Fiction, 2017-02-26    But I never felt like SFF was all that mainstream.
      
        <h6 class="perma"><a href="/2017/02/my-confrontation-with-the-mainstream/">Read More&hellip;</a></h6>
      
    </div>
    <hr>
  </div>


  
  
      <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Siri Won&#39;t Catch Alexa</h1>
    <h6 class = "date">January 14, 2017</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2017/01/siri-wont-catch-alexa/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      &ldquo;I just got an Amazon Echo and surprisingly, I really love it.&rdquo;
 In one form or another, this story has repeated again and again across the internet. So while the recent headline seemed to be &ldquo;Amazon&rsquo;s Alexa is everywhere at CES 2017&rdquo;, it really feels like this year was the Amazon Alexa year.
I have an Amazon Echo. I bought around a year ago during a sale as the buzz seemed to have peaked 1.
      
        <h6 class="perma"><a href="/2017/01/siri-wont-catch-alexa/">Read More&hellip;</a></h6>
      
    </div>
    <hr>
  </div>


  

  <div class ="row">
    <div class = "col-12">
      
      
        <a href="/page/2/" style = "float: right;">
          Next Page &rarr;
        </a>
      
    </div>
  </div>
  </div>
  <footer class = "license center">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: #fff;">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    </footer>
    </body>
</html>

