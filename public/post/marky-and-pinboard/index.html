<html>
<head>
  <link href = "http://www.jsonbecker.com/css/simple-grid.css" rel = "stylesheet" type = "text/css" />
  <link href = "http://www.jsonbecker.com/css/post.css" rel = "stylesheet" type = "text/css" />
</head>
<body>

<div class = 'container'>
  <div class = 'row'>
    <div class = 'col-6'>
      <h1>Pindown: Failed Dreams</h1>
      <h6>2014-05-13</h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-9'>
      <p>I had never thought of a use for <a href="http://www.brettterpstra.com">Brett Terpstra&rsquo;s</a> <a href="http://heckyesmarkdown.com">Marky the Markdownifier</a> before listening today&rsquo;s <a href="http://5by5.tv/systematic/96">Systematic</a>. Why would I want to turn a webpage into Markdown?</p>

<p>When I heard that Marky has an API, I was inspired. <a href="http://pinboard.in">Pinboard</a> has a &ldquo;description&rdquo; field that allows up to 65,000 characters. I never know what to put in this box. Wouldn&rsquo;t it be great to put the full content of the page in Markdown into this field?</p>

<p>I set out to write a quick Python script to:</p>

<ol>
<li>Grab recent Pinboard links.</li>
<li>Check to see if the URLs still resolve.</li>
<li>Send the link to Marky and collect a Markdown version of the content.</li>
<li>Post an updated link to Pinboard with the Markdown in the description field.</li>
</ol>

<p>If all went well, I would release this script on Github as <strong>Pindown</strong>, a great way to put Markdown page content into your Pinboard links.</p>

<p>The script below is far from well-constructed. I would have spent more time cleaning it up with things like better error handling and a more complete CLI to give more granular control over which links receive Markdown content.</p>

<p>Unfortunately, I found that Pinboard consistently returns a <a href="http://www.checkupdown.com/status/E414.html">414 error code</a> because the URLs are too long. Why is this a problem? Pinboard, in an attempt to <a href="https://pinboard.in/api/">maintain compatibility</a> with the <a href="http://del.ico.us">del.ico.us</a> API uses only GET requests, whereas this kind of request would typically use a POST end point. As a result, I cannot send along a data payload.</p>

<p>So I&rsquo;m sharing this just for folks who are interested in playing with Python, RESTful APIs, and Pinboard. I&rsquo;m also posting for my own posterity since a <a href="https://groups.google.com/d/msg/pinboard-dev/Od6sCzREeBU/L-WKgX6vUDoJ">non-Del.ico.us compatible version 2 of the Pinboard API is coming</a>.</p>

<pre><code class="language-python">import requests
import json
import yaml


def getDataSet(call):
  r = requests.get('https://api.pinboard.in/v1/posts/recent' + call)
  data_set = json.loads(r._content)
  return data_set

def checkURL(url=&quot;&quot;):
  newurl = requests.get(url)
  if newurl.status_code==200:
    return newurl.url
  else:
    raise ValueError('your message', newurl.status_code)

def markyCall(url=&quot;&quot;):
  r = requests.get('http://heckyesmarkdown.com/go/?u=' + url)
  return r._content

def process_site(call):
  data_set = getDataSet(call)
  processed_site = []
  errors = []
  for site in data_set['posts']:
    try:
      url = checkURL(site['href'])
    except ValueError:
      errors.append(site['href'])
    description = markyCall(url)
    site['extended'] = description
    processed_site.append(site)
  print errors
  return processed_site

def write_pinboard(site, auth_token):
  stem = 'https://api.pinboard.in/v1/posts/add?format=json&amp;auth_token='
  payload = {}
  payload['url'] = site.get('href')
  payload['description'] = site.get('description', '')
  payload['extended'] = site.get('extended', '')
  payload['tags'] = site.get('tags', '')
  payload['shared'] = site.get('extended', 'no')
  payload['toread'] = site.get('toread', 'no')           
  r = requests.get(stem + auth_token, params = payload)
  print(site['href'] + '\t\t' + r.status_code)

def main():
  settings = file('AUTH.yaml', 'rw')
  identity = yaml.load(AUTH.yaml)
  auth_token = identity['user_name'] + ':' + identity['token']
  valid_sites = process_site('?format=json&amp;auth_token=' + auth_token)
  for site in valid_sites:
    write_pinboard(site, auth_token)

if __name__ == '__main__':
  main()
</code></pre>

    </div>
  </div>
</div>
</body>
</html>
