<html>
<head>
  <link href = "https://micro.blog/jsonbecker" rel = "me" />
  <link href = "/css/simple-grid.css" rel = "stylesheet" type = "text/css">
  <link href = "/css/post.css" rel = "stylesheet" type = "text/css">
  
  <link rel="stylesheet" href="/css/tomorrow-night-bright.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css">
  <script src="/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
<body>
    <div class = "title-bar">
      <h1 class = "title"> json.blog </h1>
      <h3 class = "nav">
          <a href = "http://www.json.blog">Home</a> |
          <a href = "/archive">Archives</a> |
          <a href = "http://jsonbecker.com">About</a>
      </h3>
    </div>
  <div class = 'container'>


    <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>There must be an easier way... survey questions in R</h1>
    <h6 class = "date">August 22, 2012</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2012/08/there-must-be-an-easier-way...-survey-questions-in-r/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      <p>So I have this great little custom function I&rsquo;ve used when looking at survey data in R. I call this function <code>pull()</code>. The goal of <code>pull()</code> is to quickly produce frequency tables with n sizes from individual-level survey data.</p>

<p>Before using <code>pull()</code>, I create a big table that includes information about the survey questions I want to pull. The data are structured like this:</p>

<p><table align="center">
</p>
<p>
<tbody>
</p>
<p>
<tr>
</p>
<p>
<td>
quest</p>

<p></td>
</p>
<p>
<td>
survey</p>

<p></td>
</p>
<p>
<td>
year</p>

<p></td>
</p>
<p>
<td>
break</p>

<p></td>
</p>
<p>
</tr>
</p>
<p>
<tr>
</p>
<p>
<td>
ss01985</p>

<p></td>
</p>
<p>
<td>
elementary</p>

<p></td>
</p>
<p>
<td>
2011_12</p>

<p></td>
</p>
<p>
<td>
schoolcode</p>

<p></td>
</p>
<p>
</tr>
</p>
<p>
</tbody>
</p>
<p>
</table>
</p></p>

<ul>
<li>quest represents the question coding in the raw survey data.</li>
<li>survey is the name of the survey (in my case, the elementary school students, middle school students, high school students, parents, teachers, or administrators).</li>
<li>year is the year that the survey data are collected.</li>
<li>break is the ID I want to aggregate on like schoolcode or districtcode.</li>
</ul>

<p>They key is that <code>paste(survey, year,sep='')</code> produces the name of the <code>data.frame</code> where I store the relevant survey data. Both quest and break are columns in the survey data.frame. Using a data.frame with this data allows me to apply through the rows and produce the table for all the relevant questions at once. <code>pull()</code> does the work of taking one row of this <code>data.frame</code> and producing the output that I&rsquo;m looking for. I also use <code>pull()</code> one row at a time to save a data.frame that contains these data and do other things (like the visualizations in this post).</p>

<p>In some sense, <code>pull()</code> is really just a fancy version of <code>prop.table</code> that takes in passed paramaters and adds an &ldquo;n&rdquo; to each row and adding a &ldquo;total&rdquo; row. I feel as though there must be an implementation of an equivalent function in a popular package (or maybe even base) that I should be using rather than this technique. It would probably be more maintainable and easier for collaborators to work with this more common implementation, but I have no idea where to find it. So, please feel free to use the code below, but I&rsquo;m actually hoping that someone will chime in and tell me I&rsquo;ve wasted my time and I should just be using some function foo::bar.</p>

<p>P.S. This post is a great example of why I really need to change this blog to Markdown/R-flavored Markdown. All those inline references to functions, variables, or code should really be formatted in-line which the syntax highlighter plug-in used on this blog does not support. I&rsquo;m nervous that using WP-Markdown plugin will botch formatting on older posts, so I may just need to setup a workflow where I pump out HTML from the Markdown and upload the posts from there. If anyone has experience with Markdown + Wordpress, advice is appreciated.</p>

<pre><code class="language-r">pull &lt;- function(rows){
  # Takes in a vector with all the information required to create crosstab with
  # percentages for a specific question for all schools.
  # Args:
  #  rows: Consists of a vector with four objects.
  #        quest: the question code from SurveyWorks
  #        level: the &quot;level&quot; of the survey, i.e.: elem, midd, high, teac, admn,
  #        pare, etc.
  #        year: the year the survey was administered, i.e. 2011_12
  #        sch_lea: the &quot;break&quot; indicator, i.e. schoolcode, districtcode, etc.
  # Returns:
  # A data.frame with a row for each &quot;break&quot;, i.e. school, attributes for
  # each possible answer to quest, i.e. Agree and Disagree, and N size for each
  # break based on how many people responded to that question, not the survey as
  # a whole, i.e. 

  # Break each component of the vector rows into separate single-element vectors
  # for convenience and clarity.
  quest &lt;- as.character(rows[1])
  survey &lt;- as.character(rows[2])
  year  &lt;- as.character(rows[3])
  break &lt;- as.character(rows[4])
  data &lt;- get(paste(level,year,sep=''))
  # Data is an alias for the data.frame described by level and year.
  # This alias reduces the number of &quot;get&quot; calls to speed up code and increase
  # clarity.
  results &lt;- with(data,
                  dcast(data.frame(prop.table(table(data[[break]],
                                                    data[[quest]]),
                                              1))
                        ,Var1~Var2,value.var='Freq'))
  # Produces a table with the proportions for each response in wide format.
  n &lt;- data.frame(Var1=rle(sort(
    subset(data, 
           is.na(data[[quest]])==F &amp; is.na(data[[break]])==F)[[break]]))$values,
                  n=rle(sort(
                    subset(data,
                           is.na(data[[quest]])==F &amp;
                             is.na(data[[break]])==F)[[break]]))$lengths)
  # Generates a data frame with each break element and the &quot;length&quot; of that break
  # element. rle counts the occurrences of a value in a vector in order. So first
  # you sort the vector so all common break values are adjacent then you use rle
  # to count their uninterupted appearance. The result is an rle object with 
  # two components: [[values]] which represent the values in the original, sorted
  # vector and [[length]] which is the count of their uninterupted repeated
  # appearance in that vector.
  results &lt;- merge(results, n, by='Var1')
  # Combines N values with the results table.

  state &lt;- data.frame(t(c(Var1='Rhode Island', 
                          prop.table(table(data[[quest]])),
                          n=dim(subset(data,is.na(data[[quest]])==F))[1])))
  names(state) &lt;- names(results)
  for(i in 2:dim(state)[2]){
    state[,i] &lt;- as.numeric(as.character(state[,i]))
  }
  # Because the state data.frame has only one row, R coerces to type factor.
  # If I rbind() a factor to a numeric attribute, R will coerce them both to
  # characters and refuses to convert back to type numeric.
  results &lt;- rbind(results, state)
  results
}   
</code></pre>

    </div>
  </div>

  </div>
  <footer class = "license center">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: #fff;">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', "UA-40920108-1", 'auto');
  ga('send', 'pageview');
</script>
</footer>
    </body>
</html>
