<html>
<head>
  <link href = "/css/simple-grid.css" rel = "stylesheet" type = "text/css">
  <link href = "/css/post.css" rel = "stylesheet" type = "text/css">
  
  <link rel="stylesheet" href="/css/tomorrow-night-bright.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css">
  <script src="/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
	<script>
  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  	ga('create', 'UA-40920108-1', 'auto');
  	ga('send', 'pageview');
	</script>
<body>
    <div class = "title-bar">
      <h1 class = "title"> json.blog </h1>
      <h3 class = "nav">
          <a href = "http://www.json.blog">Home</a> |
          <a href = "/archive">Archives</a> |
          <a href = "http://jsonbecker.com">About</a>
      </h3>
    </div>
  <div class = 'container'>


    <div class = 'row post-title'>
    <div class = 'col-12'>
      <h1>Providence Real Estate Sales in R</h1>
    <h6 class = "date">January 23, 2012</h6> 
    <h6 class = "perma"><a href = "http://www.json.blog/2012/01/providence-real-estate-sales-in-r/">&infin;</a></h6>
    </div>
  </div>
  <div class = 'row'>
    <div class = 'col-12'>
      <p>The past few months I&rsquo;ve been learning how to use R. This morning, I decided to try out two first&ndash; importing a table of data that is being read of the web and overlaying location data onto a map.</p>

<p>With a little bit of Google skills and just enough R know-how I was able to produce this image:</p>

<p><img src="/img/homesales.png" alt="Providence Home Sales 9-12-11 to 12-27-11" title="Providence Home Sales 9-12-11 to 12-27-11" /></p>

<p>There were a few things that were kind of tricky for me. First, for sometime I couldn&rsquo;t get latitude and longitude components for the addresses. I figured there was something wrong with the way I was using the *apply class of functions in R. apply() (and the related class of functions lapply, sapply, etc.) are really handy if a bit tricky for beginning R users. This function permits quickly &ldquo;applying&rdquo; a function across multiple elements. Traditionally this is done with a loop, but the apply() functions &ldquo;vectorize&rdquo; this process (R folks always talk about making your code more vectorized which has something to do with the structure of objects in R but is beyond my computer science skills&ndash; essentially, vectorized code runs much faster and more efficiency than loops because of some underlying feature of the language). After playing around with apply, lapply, and sapply, I decided to move back into my &ldquo;old&rdquo; way of thinking and just write a loop:</p>

<pre><code class="language-r">latlongroll &lt;- function(address){
  lat &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
  lng &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
  for(i in 1:length(address)){
    latlong &lt;- gGeoCode(address[i])
    lat[i]&lt;-latlong[1]
    lng[i]&lt;-latlong[2]
  }
  return(cbind(lat,lng))
} 
</code></pre>

<p>This still didn&rsquo;t work&ndash; I kept on getting a strange out-of-bounds call. So I decided to go down the rabbit hole of regular expressions and try and see if I could clean up my addresses any further (I couldn&rsquo;t). So, now seemed as good a time as any to figure out how to print to the console while a loop is running to keep track of progress and where exactly my function was stopped. This turned out to be a bit tricky because I didn&rsquo;t know you had to include a tricky line, <code>r flush.console()</code> in order to get the prints to work. When I figured this out I found out my loop was being caught on my 7th element, a perfectly well formed address. When I ran gGeoCode() on that address only it worked fine. So I thought, maybe Google is bouncing me out because I&rsquo;m hitting it too fast? And bingo, the final (working version):</p>

<pre><code class="language-r">latlongroll &lt;- function(address){
 lat &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
 lng &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
 for(i in 1:length(address)){
  print(i)
  flush.console()
  latlong &lt;- gGeoCode(address[i])
  lat[i]&lt;-latlong[1]
  lng[i]&lt;-latlong[2]
  Sys.sleep(0.5)
 }
 return(cbind(lat,lng))
}
</code></pre>

<p>Other than that, the whole process was pretty straight forward. I have to thank Tony Breyal for <a href="http://stackoverflow.com/questions/3257441/geocoding-in-r-with-google-maps">posting the functions I used</a> to get latitude and longitude on <a href="http://stackoverflow.com/">Stack Overflow</a>. Also, I found the <a href="http://cran.r-project.org/web/packages/RgoogleMaps/vignettes/RgoogleMaps-intro.pdf">RgoogleMaps vignette</a> to be very helpful, although I wish it had slightly better explained what was going on in qbbox().</p>

<p>Finally, my full source for the above:</p>

<pre><code class="language-r"># Providence Real Estate Transactions over the last 40 days.
# Required Packages
require('XML')
require('RCurl')
require('RJSONIO')
require(&quot;RgoogleMaps&quot;)
# Functions
# Construct URL required to get the Lat and Long from Google Maps
construct.geocode.url &lt;- function(address, return.call = &quot;json&quot;, sensor = &quot;false&quot;   ) {
 root &lt;- &quot;http://maps.google.com/maps/api/geocode/&quot;
 u &lt;- paste(root, return.call, &quot;?address=&quot;, address, &quot;&amp;sensor=&quot;, sensor, sep = &quot;&quot;   )
 return(URLencode(u))
}
# Now that we have the proper Google Maps address, get the resulting latitude     and longitude
gGeoCode &lt;- function(address) {
 u &lt;- construct.geocode.url(address)
 doc &lt;- getURL(u)
 x &lt;- fromJSON(doc,simplify = FALSE)
 lat &lt;- x$results[[1]]$geometry$location$lat
 lng &lt;- x$results[[1]]$geometry$location$lng
 return(c(lat, lng))
}
# Roll through addresses to create lat long
latlongroll &lt;- function(address){
# Initializing the length of a vector dramatically speeds up the code. Far 
# better than reassigning and resizing each time in the loop.
 lat &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
 lng &lt;- vector(mode = &quot;numeric&quot;, length = length(address))
 for(i in 1:length(address)){
# I kept the print in because this function takes a long time to run so I 
# like  to watch its progress.
 print(i)
 flush.console()
# To reduce the calls, I chose to store lat and long locally before 
# separating the two whereas initially I hit Google for each separately
 latlong &lt;- gGeoCode(address[i])
 lat[i]&lt;-latlong[1]
 lng[i]&lt;-latlong[2]
# I'll have to experiment with the sleep time. I'm certain 0.5 seconds is 
# too long (and this is the bulk of the time spent on the whole code).
 Sys.sleep(0.5)
 }
 return(cbind(lat,lng))
}

# Open to the most recent real estate transactions for Providence on the 
# Projo
site &lt;- 'http://www.providencejournal.com/homes/real-estate-transactions/assets/pages/real-estate-transactions-providence.htm'
# Read in the table with the header as variable names.
realestate.table&lt;-readHTMLTable(site,header=T,which=1,stringsAsFactors=F)
# Remove the $ sign before the price
realestate.table$Price &lt;- gsub(&quot;([$]{1})([0-9]+)&quot;, &quot;\\2&quot;, 
                               realestate.table$Price)
# Cast price character as numeric
realestate.table$Price&lt;-as.numeric(realestate.table$Price)
# Cast date string as date type (lowercase %y means 2-digit year, 
# uppercase is 4 digit)
realestate.table$Date &lt;- as.Date(realestate.table$Date,format='%m/%d/%y')
# Dummy transactions or title changes have a price of $1, removing those 
# from data set
providence &lt;- subset(realestate.table,Price&gt;1)
# Removing properties that do not have an address that start with a street 
# number
providence &lt;- subset(providence, grepl(&quot;^[0-9]+&quot;, providence$Address))
# Add lat and lng coordinates to each address
providence&lt;-cbind(providence, latlongroll(providence[,3]))
# Calculate boundary lat and long for map
bb &lt;- qbbox(providence$lat, providence$lng)
# Gets a map from Google Maps
map &lt;- GetMap.bbox(bb$lonR, bb$latR, zoom=12, maptype=&quot;mobile&quot;)
# plot the points
PlotOnStaticMap(map,lon=providence$lng,lat=providence$lat)
</code></pre>

    </div>
  </div>

  </div>
  <footer class = "license center">
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="color: #fff;">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
    </footer>
    </body>
</html>
